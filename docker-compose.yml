# rallyforge Platform - Docker Compose Configuration
# Phase 3 - DevOps Implementation
# Full stack deployment with backend, database, and frontend

version: '3.8'

services:
  # ============================================================================
  # PostgreSQL Database
  # ============================================================================
  db:
    image: postgres:15-alpine
    container_name: rallyforge-db
    environment:
      POSTGRES_USER: rallyforge
      POSTGRES_PASSWORD: rallyforge_secure_password
      POSTGRES_DB: rallyforge
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./SQL:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - rallyforge-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rallyforge"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # Backend API (FastAPI)
  # ============================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rallyforge-backend
    environment:
      # Database
      DATABASE_URL: postgresql://rallyforge:rallyforge_secure_password@db:5432/rallyforge
      DB_POOL_SIZE: 10
      DB_MAX_OVERFLOW: 20

      # Application
      APP_ENV: production
      LOG_LEVEL: INFO
      DEBUG: "false"

      # CORS
      ALLOWED_ORIGINS: http://localhost:3000,http://frontend:3000

      # Uploads
      UPLOAD_DIR: /app/uploads
      MAX_UPLOAD_SIZE: 10485760  # 10MB

    volumes:
      - ./uploads:/app/uploads
      - ./backend:/app/backend
      - ./config:/app/config
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - rallyforge-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        sleep 5 &&
        echo 'Initializing database...' &&
        python backend/bin/init_database.py init &&
        echo 'Starting API server...' &&
        uvicorn backend.app.main:app --host 0.0.0.0 --port 8000 --reload
      "

  # ============================================================================
  # Frontend (React - Optional for local development)
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rallyforge-frontend
    environment:
      REACT_APP_API_URL: http://backend:8000
      NODE_ENV: production
    ports:
      - "3000:3000"
    depends_on:
      - backend
    networks:
      - rallyforge-network
    restart: unless-stopped

  # ============================================================================
  # pgAdmin (Database Management - Optional)
  # ============================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: rallyforge-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@rallyforge.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    depends_on:
      - db
    networks:
      - rallyforge-network
    restart: unless-stopped
    profiles:
      - dev  # Only start with: docker-compose --profile dev up

# ============================================================================
# Volumes
# ============================================================================
volumes:
  postgres_data:
    driver: local

# ============================================================================
# Networks
# ============================================================================
networks:
  rallyforge-network:
    driver: bridge

# ============================================================================
# USAGE INSTRUCTIONS
# ============================================================================
#
# Start all services:
#   docker-compose up -d
#
# Start with pgAdmin:
#   docker-compose --profile dev up -d
#
# View logs:
#   docker-compose logs -f backend
#   docker-compose logs -f db
#
# Stop all services:
#   docker-compose down
#
# Stop and remove volumes:
#   docker-compose down -v
#
# Rebuild containers:
#   docker-compose up -d --build
#
# Access services:
#   Backend API: http://localhost:8000/docs
#   Frontend: http://localhost:3000
#   pgAdmin: http://localhost:5050
#   Database: localhost:5432
#
# Initialize database manually:
#   docker-compose exec backend python backend/bin/init_database.py init
#
# Verify database:
#   docker-compose exec backend python backend/bin/init_database.py verify
#
# Check health:
#   docker-compose exec backend python backend/bin/init_database.py health
#

